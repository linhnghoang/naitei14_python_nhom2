{% extends "admin/index.html" %}
{% load admin_urls static %}

{% block title %}{{ title }} | {{ site_title|default:_('Django site admin') }}{% endblock %}

{% block branding %}
<h1 id="site-name">
    <a href="{% url 'admin:index' %}">
        <i class="fa-solid fa-book-open"></i>
        Library Management System
    </a>
</h1>
{% endblock %}

{% block extrahead %}
{{ block.super }}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
    /* Custom styling for the admin interface */
    #site-name a {
        text-decoration: none;
        color: #fff;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    #site-name i {
        font-size: 24px;
    }
    
    /* Layout wrapper for the dashboard */
    .admin-dashboard {
        display: grid;
        grid-template-columns: 3fr 1fr;
        gap: 24px;
        align-items: start;
    }

    @media (max-width: 1200px) {
        .admin-dashboard {
            grid-template-columns: 1fr;
        }
    }

    .dashboard-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin: 20px 0;
    }
    
    .stat-card {
        background: #fff;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border-left: 4px solid #007cba;
        transition: transform 0.2s;
    }
    
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .stat-number {
        font-size: 32px;
        font-weight: bold;
        color: #007cba;
        margin: 0;
    }
    
    .stat-label {
        color: #666;
        margin: 5px 0 0 0;
        text-transform: uppercase;
        font-size: 12px;
        letter-spacing: 1px;
    }
    
    .stat-icon {
        float: right;
        font-size: 24px;
        color: #007cba;
        opacity: 0.7;
    }
    
    .quick-actions {
        background: #fff;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .quick-actions h3 {
        margin-top: 0;
        color: #333;
        border-bottom: 2px solid #007cba;
        padding-bottom: 10px;
    }
    
    .action-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 15px;
        margin-top: 20px;
    }
    
    .action-button {
        display: inline-block;
        background: #007cba;
        color: white;
        text-decoration: none;
        padding: 15px 20px;
        border-radius: 6px;
        text-align: center;
        transition: background 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        width: 100%;
        min-height: 46px;
        font-weight: 600;
    }
    
    .action-button:hover {
        background: #005a87;
        color: white;
        text-decoration: none;
    }
    
    .recent-activity {
        background: #fff;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .recent-activity h3 {
        margin-top: 0;
        color: #333;
        border-bottom: 2px solid #007cba;
        padding-bottom: 10px;
    }
    
    .activity-item {
        padding: 10px 0;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .activity-item:last-child {
        border-bottom: none;
    }
    
    .activity-time {
        color: #666;
        font-size: 12px;
    }
    
    /* Override default Django admin colors */
    #header {
        background: linear-gradient(135deg, #007cba 0%, #005a87 100%);
    }
    
    .module h2, .module caption, .inline-group h2 {
        background: #007cba;
    }
    
    a:link, a:visited {
        color: #007cba;
    }
    
    .button, input[type=submit], input[type=button], .submit-row input, a.button {
        background: #007cba;
        border-color: #007cba;
    }
    
    .button:hover, input[type=submit]:hover, input[type=button]:hover, .submit-row input:hover, a.button:hover {
        background: #005a87;
    }

    /* Ensure quick action buttons show white text regardless of global link color */
    .action-button,
    .action-button:link,
    .action-button:visited,
    .action-button:hover,
    .action-button:active,
    .action-button:focus {
        color: #fff !important;
    }

    /* Category-specific styling */
    .category-stats {
        background: #fff;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .category-stats h3 {
        margin-top: 0;
        color: #333;
        border-bottom: 2px solid #007cba;
        padding-bottom: 10px;
    }

    .category-overview {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 15px;
    }

    .category-item {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 6px;
        border-left: 4px solid #007cba;
    }

    .category-name {
        font-weight: 600;
        color: #333;
        margin-bottom: 5px;
    }

    .category-meta {
        font-size: 12px;
        color: #666;
    }
</style>
{% endblock %}

{% block content %}
<div class="admin-dashboard">
    <div class="left-col">
        <div class="dashboard-stats">
            <div class="stat-card">
                <i class="fa-solid fa-tags stat-icon"></i>
                <p class="stat-number" id="categories-count">-</p>
                <p class="stat-label">Total Categories</p>
            </div>
            
            <div class="stat-card">
                <i class="fa-solid fa-sitemap stat-icon"></i>
                <p class="stat-number" id="top-level-count">-</p>
                <p class="stat-label">Top Level Categories</p>
            </div>
            
            <div class="stat-card">
                <i class="fa-solid fa-folder stat-icon"></i>
                <p class="stat-number" id="categories-with-children">-</p>
                <p class="stat-label">Categories with Subcategories</p>
            </div>
            
            <div class="stat-card">
                <i class="fa-solid fa-folder-open stat-icon"></i>
                <p class="stat-number" id="empty-categories">-</p>
                <p class="stat-label">Empty Categories</p>
            </div>
        </div>

        <div class="category-stats">
            <h3><i class="fa-solid fa-sitemap"></i> Category Overview</h3>
            <div class="category-overview" id="categoryOverview">
                <div class="loading" style="text-align: center; padding: 20px; color: #666;">
                    Loading category data...
                </div>
            </div>
        </div>

        {{ block.super }}
    </div>

    <aside class="right-col">
        <div class="quick-actions">
            <h3><i class="fa-solid fa-bolt"></i> Quick Actions</h3>
            <div class="action-grid">
                <a href="{% url 'admin:catalog_category_changelist' %}" class="action-button">
                    <i class="fa-solid fa-tags"></i>
                    Manage Categories
                </a>
                <a href="{% url 'admin:catalog_category_add' %}" class="action-button">
                    <i class="fa-solid fa-plus"></i>
                    Add Category
                </a>
                <a href="{% url 'admin_export_categories_excel' %}" class="action-button">
                    <i class="fa-solid fa-file-excel"></i>
                    Export Categories
                </a>
            </div>
        </div>
        <div class="recent-activity">
            <h3><i class="fa-solid fa-clock-rotate-left"></i> Recent Activity</h3>
            <div id="recent-activity-list">
                <p>Loading recent activity...</p>
            </div>
        </div>
    </aside>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Load dashboard statistics from API
    fetch('{% url "admin_stats_api" %}')
        .then(response => response.json())
        .then(data => {
            document.getElementById('categories-count').textContent = data.basic.total_categories.toLocaleString();
        })
        .catch(error => {
            console.error('Error loading stats:', error);
            document.getElementById('categories-count').textContent = '-';
        });
    
    // Load category-specific statistics
    fetch('{% url "admin_category_stats_api" %}')
        .then(response => response.json())
        .then(data => {
            document.getElementById('top-level-count').textContent = data.summary.top_level_count.toLocaleString();
            document.getElementById('categories-with-children').textContent = data.parent_categories.length.toLocaleString();
            document.getElementById('empty-categories').textContent = data.empty_categories.length.toLocaleString();
        })
        .catch(error => {
            console.error('Error loading category stats:', error);
            document.getElementById('top-level-count').textContent = '-';
            document.getElementById('categories-with-children').textContent = '-';
            document.getElementById('empty-categories').textContent = '-';
        });
    
    // Load category overview
    fetch('{% url "admin_category_stats_api" %}')
        .then(response => response.json())
        .then(data => {
            const categoryOverview = document.getElementById('categoryOverview');
            
            if (data.popular_categories && data.popular_categories.length > 0) {
                categoryOverview.innerHTML = data.popular_categories.slice(0, 8).map(category => `
                    <div class="category-item">
                        <div class="category-name">${category.name}</div>
                        <div class="category-meta">
                            ${category.books_count} books â€¢ ${category.slug}
                        </div>
                    </div>
                `).join('');
            } else {
                categoryOverview.innerHTML = '<div class="category-item">No categories found</div>';
            }
        })
        .catch(error => {
            console.error('Error loading category overview:', error);
            document.getElementById('categoryOverview').innerHTML = '<div class="category-item">Error loading categories</div>';
        });
    
    // Load recent activity from API
    fetch('{% url "admin_activity_api" %}')
        .then(response => response.json())
        .then(data => {
            const activityList = document.getElementById('recent-activity-list');
            if (data.activities && data.activities.length > 0) {
                activityList.innerHTML = data.activities.map(activity => `
                    <div class="activity-item">
                        <div>
                            <strong>${activity.message}</strong>
                            <br><small>${activity.details}</small>
                        </div>
                        <div class="activity-time">${activity.ago}</div>
                    </div>
                `).join('');
            } else {
                activityList.innerHTML = '<p>No recent activity</p>';
            }
        })
        .catch(error => {
            console.error('Error loading activity:', error);
            const activityList = document.getElementById('recent-activity-list');
            activityList.innerHTML = '<p>Error loading recent activity</p>';
        });
});
</script>
{% endblock %}